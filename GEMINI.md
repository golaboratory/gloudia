# GEMINI.md - gloudia 開発ガイド

このドキュメントは、`gloudia`プロジェクトの概要、構造、および将来の開発を円滑に進めるためのワークフローについて説明します。

## 1. プロジェクト概要

**gloudia** (`github.com/golaboratory/gloudia`) は、`golaboratory`エコシステムのためのコアユーティリティとインフラストラクチャコンポーネントを提供する共有 Go ライブラリです。API 処理、認証、データベース接続、リアルタイムメッセージング、レポーティングなどの共通ロジックをカプセル化し、サービス間でのコード再利用を促進します。

## 2. 技術スタック

- **言語**: Go 1.25.0
- **データベースドライバ**: `pgx/v5` (PostgreSQL), `go-redis/v9` (Redis)
- **API & Web**: `huma/v2` (API フレームワーク), `go-chi/cors`, `gorilla/websocket`
- **認証**: `paseto` (セキュリティトークン), `otp` (ワンタイムパスワード)
- **レポーティング**: `excelize/v2` (Excel 生成)
- **ユーティリティ**: `ergo` (エラーハンドリング/Utils), `envconfig` (設定管理)

## 3. ディレクトリ構造とモジュール

プロジェクトは、ルートレベルでモジュール化されたパッケージに構成されています：

- **`api/`**: API 定義ヘルパーとユーティリティ（Huma 統合など）。
- **`auth/`**: 認証ロジック。Paseto トークン管理や OTP 生成など。
- **`datetime/`**: 日付・時刻ユーティリティ（六曜計算などを含む）。
- **`environment/`**: 環境変数設定と管理。
- **`infra/`**: インフラストラクチャコンポーネント。データベース接続プール（PostgreSQL）や Redis クライアントなど。
- **`json/`**: カスタム JSON 共有ヘルパーとユーティリティ。
- **`middleware/`**: HTTP ミドルウェアコンポーネント（ログ出力、CORS、認証検証など）。
- **`net/`**: ネットワーク関連ユーティリティ。
- **`realtime/`**: リアルタイム通信機能。
  - _現在の焦点_: WebSocket Hub の実装 (`hub.go`, `client.go`)。
- **`reporting/`**: レポーティングモジュール。
  - Excel 生成のための `excel/` を含む。
- **`worker/`**: バックグラウンドワーカーの定義とユーティリティ。
- **`_testdata/`**: 共有テストデータファイル。

## 4. 主要設定ファイル

- **`go.mod`**: モジュール名 `github.com/golaboratory/gloudia` と依存関係を定義。
- **`.github/workflows/ci.yml`**: 継続的インテグレーション（CI）ワークフロー。
  - `push` 時にトリガー。
  - `go test -v ./...` を実行。

## 5. 開発ワークフロー

### 前提条件

- Go 1.25 以上がインストールされていること。
- 依存関係へのアクセス権があること（モジュールはパブリックまたはベンダリング済み）。

### 一般的なコマンド

- **テストの実行**:
  ```bash
  go test -v ./...
  ```
- **依存関係のダウンロード**:
  ```bash
  go mod download
  ```
- **モジュールの整理**:
  ```bash
  go mod tidy
  ```

## 6. 現在の開発コンテキスト

- **アクティブなモジュール**: `realtime`
- **焦点**: 接続されたユーザーへメッセージをブロードキャストするための WebSocket Hub (`Hub`) と Client 管理の実装と改善。
- **最近の変更**:
  - 並行処理でも安全なマップ管理を持つ `Hub` 構造体のインフラ整備。
  - ログ出力のための `slog` の統合。

---

_Created by Antigravity on 2026-01-03_
